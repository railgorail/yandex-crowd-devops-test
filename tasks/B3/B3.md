## Задание B3: "Объясни концепцию" (Понимание CI/CD)

### Схема автоматической сборки Docker-образа при пуше в ветку main

Когда разработчик пушит код в ветку `main` в GitLab/GitHub, запускается CI/CD pipeline следующего вида:

### Процесс по шагам(этапам)
Если на любом этапе происходит ошибка -> отправка уведомления о провале в Telegram -> завершение pipeline с ошибкой.
```md
Push в main
|
Запуск CI/CD Pipeline (автоматический триггер)
|
Checkout кода
|
Запуск тестов
| (если тесты прошли)
Сборка Docker-образа
|
Теггирование образа (например, latest, commit SHA)
|
Push образа в Docker Hub
| (если push успешен)
Уведомление в Telegram (успех)
|
Завершение pipeline
```



### Подробное описание этапов

#### Этап 1: Push в ветку main
Разработчик выполняет `git push origin main`, что вызывает webhook в GitLab/GitHub.

#### Этап 2: Запуск CI/CD Pipeline
CI/CD система (GitLab CI, GitHub Actions) обнаруживает push в `main` и автоматически запускает pipeline, определенный в `.gitlab-ci.yml` или `.github/workflows/*.yml`.

#### Этап 3: Checkout кода
CI/CD система клонирует репозиторий в чистую среду выполнения (runner) на нужную ветку/коммит.

#### Этап 4: Запуск линтеров и множества тестов
Выполняются различные тесты (порядок запусков имеет значение):
- Линтинг кода
- Unit-тесты
- Integration-тесты
- Проверка безопасности

Если тесты не прошли -> отправка уведомления о провале -> остановка pipeline.

#### Этап 5: Сборка Docker-образа
Если тесты прошли успешно, выполняется:
```bash
docker build -t my-app:latest -t my-app:$CI_COMMIT_SHA .
```

Где `$CI_COMMIT_SHA` - хэш коммита для уникальной версии образа.

#### Этап 6: Тегирование образа
Образ тегируется несколькими тегами:
- `latest` - для последней версии
- `$CI_COMMIT_SHA` - для конкретного коммита
- Возможно, `$CI_COMMIT_TAG` или версия из проекта

#### Этап 7: Push образа в Docker Hub
Выполняется авторизация в Docker Hub и push образа:
```bash
docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
docker push my-app:latest
docker push my-app:$CI_COMMIT_SHA
```

#### Этап 8: Уведомление в Telegram
После успешного push отправляется уведомление в Telegram через бота:
- Успех: "УСПЕХ: Build успешно завершен. Образ my-app:$CI_COMMIT_SHA отправлен в Docker Hub"
- Провал: "ПРОВАЛ: Build провален на этапе [название этапа]. Ошибка: [детали]"

#### Этап 9: Завершение pipeline
Pipeline завершается с соответствующим статусом (success/failed).

### Необходимые секреты/переменные окружения
- `DOCKER_USERNAME` / `DOCKER_PASSWORD` 
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_CHAT_ID`

### Пример конфигурации GitLab CI (.gitlab-ci.yml)

```yaml
stages:
  - test
  - build
  - deploy
  - notify

variables:
  DOCKER_IMAGE: my-app
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: $CI_REGISTRY_USER

before_script:
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD $DOCKER_REGISTRY

test:
  stage: test
  image: node:18
  script:
    - npm install
    - npm run lint
    - npm test
  only:
    - main

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_IMAGE:latest .
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_IMAGE:$CI_COMMIT_SHA .
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_IMAGE:latest
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_IMAGE:$CI_COMMIT_SHA
  only:
    - main
  dependencies:
    - test

notify_success:
  stage: notify
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - |
      curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
        -d "chat_id=$TELEGRAM_CHAT_ID" \
        -d "text=УСПЕХ: Build успешно завершен. Образ $DOCKER_IMAGE:$CI_COMMIT_SHA отправлен в Docker Hub"
  only:
    - main
  when: on_success

notify_failure:
  stage: notify
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - |
      curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
        -d "chat_id=$TELEGRAM_CHAT_ID" \
        -d "text=ПРОВАЛ: Build провален. Проверьте логи pipeline: $CI_PIPELINE_URL"
  only:
    - main
  when: on_failure
```

### Пример конфигурации GitHub Actions (.github/workflows/build.yml)

```yaml
name: Build and Push Docker Image

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install
      - run: npm run lint
      - run: npm test

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            my-app:latest
            my-app:${{ github.sha }}
      
      - name: Send Telegram notification (success)
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            УСПЕХ: Build успешно завершен
            Образ my-app:${{ github.sha }} отправлен в Docker Hub
      
      - name: Send Telegram notification (failure)
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ПРОВАЛ: Build провален
            Проверьте логи: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
```